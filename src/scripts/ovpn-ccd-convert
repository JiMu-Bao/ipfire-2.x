#!/usr/bin/perl
###############################################################################
#                                                                             #
# IPFire.org - A linux based firewall                                         #
# Copyright (C) 2007-2022  IPFire Team  <info@ipfire.org>                     #
#                                                                             #
# This program is free software: you can redistribute it and/or modify        #
# it under the terms of the GNU General Public License as published by        #
# the Free Software Foundation, either version 3 of the License, or           #
# (at your option) any later version.                                         #
#                                                                             #
# This program is distributed in the hope that it will be useful,             #
# but WITHOUT ANY WARRANTY; without even the implied warranty of              #
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the               #
# GNU General Public License for more details.                                #
#                                                                             #
# You should have received a copy of the GNU General Public License           #
# along with this program.  If not, see <http://www.gnu.org/licenses/>.       #
#                                                                             #
###############################################################################

my %net=();
my %ovpnconfig=();
my @serverconf=();
my $greennet;
my $greensubnet;
my $running='off';

require '/var/ipfire/general-functions.pl';
unless (-d "${General::swroot}/ovpn/ccd") { system("mkdir ${General::swroot}/ovpn/ccd"); }
system ("chown nobody.nobody ${General::swroot}/ovpn/ccd");
if ( -e "/var/run/openvpn.pid"){
	$running='on';
	system('/usr/local/bin/openvpnctrl', '-k');
}

&General::readhash("/var/ipfire/ethernet/settings", \%net);
	$greennet=$net{'GREEN_NETADDRESS'};
	$greensubnet=$net{'GREEN_NETMASK'};
open(FILE,"/var/ipfire/ovpn/server.conf");
				while (<FILE>) {
					$_=~s/\s*$//g;
					if ($_ ne "route $greennet $greensubnet"){
						push (@serverconf,$_."\n");
					}else{
						print"\nFound ROUTE >>route $greennet $greensubnet<< in server.conf.. Deleted!";
					}
				}

&General::readhasharray("/var/ipfire/ovpn/ovpnconfig", \%ovpnconfig);
foreach my $key (keys %ovpnconfig){
	if($ovpnconfig{$key}[32] eq '' && $ovpnconfig{$key}[3] eq 'host'){
		$ovpnconfig{$key}[2] =~ s/ /_/gi;
		open ( CCDRWCONF,'>',"/var/ipfire/ovpn/ccd/$ovpnconfig{$key}[2]") or die "Unable to create clientconfigfile $!";
		print CCDRWCONF "# OpenVPN Clientconfig from CCD extension by Copymaster#\n\n";
		print CCDRWCONF "#This client uses the dynamic pool\n\n";
		print CCDRWCONF "\n#Client gets routes to these Networks (behind IPFIRE)\n";
		print CCDRWCONF "push \"route $greennet $greensubnet\"\n";
		close CCDRWCONF;
		print"Client $ovpnconfig{$key}[2] converted! \n";
	}else{
		print "Client $ovpnconfig{$key}[2] NOT converted!\n";
	}
	$ovpnconfig{$key}[32] = 'dynamic' if ($ovpnconfig{$key}[32] eq '');
}
&General::writehasharray("/var/ipfire/ovpn/ovpnconfig", \%ovpnconfig);
if ($running eq 'on')
{
	system('/usr/local/bin/openvpnctrl', '-s');
}
system ("chown nobody:nobody /var/ipfire/ovpn/ccd/*");
