###############################################################################
#                                                                             #
# IPFire.org - A linux based firewall                                         #
# Copyright (C) 2007-2022  IPFire Team  <info@ipfire.org>                     #
#                                                                             #
# This program is free software: you can redistribute it and/or modify        #
# it under the terms of the GNU General Public License as published by        #
# the Free Software Foundation, either version 3 of the License, or           #
# (at your option) any later version.                                         #
#                                                                             #
# This program is distributed in the hope that it will be useful,             #
# but WITHOUT ANY WARRANTY; without even the implied warranty of              #
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the               #
# GNU General Public License for more details.                                #
#                                                                             #
# You should have received a copy of the GNU General Public License           #
# along with this program.  If not, see <http://www.gnu.org/licenses/>.       #
#                                                                             #
###############################################################################

. /etc/sysconfig/rc
. $rc_functions
. /etc/init.d/networking/functions.network

eval $(/usr/local/bin/readhash /var/ipfire/ethernet/settings)

dhcpcd_up()
{
	set | grep "^new_" | sed "s|^new_||g" | \
	sort > /var/ipfire/dhcpc/dhcpcd-$interface.info

	#Check if this was the Red device...
	if [ ! "$interface" == "$RED_DEV" ]; then
		exit 0;
	fi

	# Only if RED_TYPE=DHCP update /var/ipfire/red
	# Check if we have to restart the services at update
	[ ! -e "/var/ipfire/red/active" ] && update=1;
	if [ "$old_domain_name_service" != "$new_domain_name_service" ]; then
		update=1;
	fi
	if [ "$old_ip_address" != "$new_ip_address" ]; then
		update=1;
	fi
	if [ "$old_routers" != "$new_routers" ]; then
		update=1;
	fi

	# Get DNS from dhcp
	/etc/rc.d/helper/getdnsfromdhcpc.pl 1 > /var/run/dns1
	/etc/rc.d/helper/getdnsfromdhcpc.pl 2 > /var/run/dns2

	#Get IP Address
	echo -n "$new_ip_address"  > /var/ipfire/red/local-ipaddress

	#Get default gateway
	grep -v -E "\<gateway\>" /etc/hosts > /tmp/hosts
	echo "$new_routers	gateway"  >> /tmp/hosts
	mv /tmp/hosts /etc/hosts

	if [ $update ]; then
		[ -e "/var/ipfire/red/active" ] || touch /var/ipfire/red/active
		echo -n "$new_routers" > /var/ipfire/red/remote-ipaddress
		logger -p local0.info -t dhcpcd.exe[$$] "$interface has been (re)configured with IP=$new_ip_address"
		run_subdir ${rc_base}/init.d/networking/red.up/
		touch /var/ipfire/red/active
	fi
}

dhcpcd_down()
{
	set | grep "^new_" | sed "s|^new_||g" | \
	sort > /var/ipfire/dhcpc/dhcpcd-$interface.info

	# Remove DNS servers
	rm -f /var/run/dns1 /var/run/dns2

	# Only if RED_TYPE=DHCP update /var/ipfire/red
	if [ "$RED_TYPE" == "DHCP" ]; then
		rm -f /var/ipfire/red/active
		if [ ! $reason == "PREINIT" ]; then
			logger -p local0.info -t dhcpcd.exe[$$] "${interface} has been brought down ($reason)"
			run_subdir ${rc_base}/init.d/networking/red.down/
		fi
	fi
}

# Called when dhcpcd relies on a third party to configure an IP address
dhcpcd_3rdparty() {
	local qmi_device="$(qmi_find_device "${interface}")"

	if [ -n "${qmi_device}" ]; then
		setup_qmi "${qmi_device}" || return $?
	fi

	return 0
}

setup_qmi() {
	local device="${1}"

	local address
	local netmask
	local gateway
	local mtu=1500

	local line
	while read -r line; do
		# Extract the value
		value="${line#*: }"

		case "${line}" in
			*IPv4\ address:*)
				address="${value}"
				;;
			*IPv4\ subnet\ mask:*)
				netmask="${value}"
				;;
			*IPv4\ gateway\ address:*)
				gateway="${value}"
				;;
			*MTU:*)
				mtu="${value}"
				;;
		esac
	done <<< "$(qmicli --device="${device}" --wds-get-current-settings)"

	if [ -z "${address}" ] || [ -z "${netmask}" ] || [ -z "${gateway}" ]; then
		logger -p "local0.info" -t "dhcpcd.exe[$$]" \
			"Could not retrieve all information from the QMI interface"
		return 1
	fi

	# Flush any previous configuration
	ip addr flush dev "${interface}"

	# Configure the IP address
	ip addr add "${address}/${netmask}" dev "${interface}"

	# Configure the default route
	ip route add default via "${gateway}" #mtu "${mtu}"

	return 0
}

case "$reason" in
BOUND|INFORM|REBIND|REBOOT|RENEW|TIMEOUT|STATIC)	dhcpcd_up;;
PREINIT|EXPIRE|FAIL|IPV4LL|NAK|RELEASE|STOP)		dhcpcd_down;;
3RDPARTY)
	dhcpcd_3rdparty
	;;
*)
	logger -p "local0.info" -t "dhcpcd.exe[$$]" "Unhandled DHCP event: ${reason}"
	;;
esac
